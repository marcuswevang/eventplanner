generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// --- Enums ---

enum EventType {
  WEDDING
  CHRISTENING
  NAMING_CEREMONY
  CONFIRMATION
  JUBILEE
  OTHER
}

enum GuestType {
  DINNER
  PARTY
}

enum RsvpStatus {
  PENDING
  ACCEPTED
  DECLINED
}

enum TableShape {
  ROUND
  SQUARE
  RECTANGLE
  LONG
}

enum GallerySource {
  UPLOAD
  INSTAGRAM
}

enum UserRole {
  CUSTOMER
  SUPER_ADMIN
}

// --- Core Models ---

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // Hashed
  name      String?
  role      UserRole @default(CUSTOMER)
  isActivated Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  mobile    String?
  lastLogin DateTime?



  events    Event[]  @relation("UserEvents")
  resetTokens PasswordResetToken[]
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  expires   DateTime
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model Event {
  id              String    @id @default(cuid())
  slug            String    @unique // e.g., "mitt-bryllup-2026"
  name            String
  type            EventType @default(WEDDING)
  date            DateTime
  guestPassword   String?   // Shared password for guests
  isActive        Boolean   @default(true) // Superadmin can toggle this
  customDomain    String?   @unique // Optional custom domain mapping
  budgetGoal      Float?    @default(0)
  
  // Settings (Json for flexibility)
  // Contains: primaryHosts, subjectName, locations, etc.
  settings        Json?     
  
  // Config (Feature Toggles)
  // Contains: budgetEnabled, wishlistEnabled, spotifyId, instagramHash, etc.
  config          Json?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  users           User[]    @relation("UserEvents")
  guests          Guest[]
  tables          Table[]
  wishlistItems   WishlistItem[]
  songRequests    SongRequest[]
  budgetItems     BudgetItem[]
  galleryItems    GalleryItem[]
}


// --- Feature Models ---

model Guest {
  id         String     @id @default(cuid())
  eventId    String
  event      Event      @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  name       String
  type       GuestType
  allergies  String?
  rsvpStatus RsvpStatus @default(PENDING)
  mobile     String?
  address    String?
  role       String?    // e.g., "Toastmaster", "Godparent"
  
  tableId    String?
  table      Table?     @relation(fields: [tableId], references: [id])
  
  partnerId  String?    @unique
  partner    Guest?     @relation("GuestPartner", fields: [partnerId], references: [id])
  partnerOf  Guest?     @relation("GuestPartner")
  
  hasSpeech  Boolean    @default(false)
  createdAt  DateTime   @default(now())
}

model Table {
  id        String     @id @default(cuid())
  eventId   String
  event     Event      @relation(fields: [eventId], references: [id], onDelete: Cascade)

  name      String     // Table number or name
  capacity  Int        @default(8)
  shape     TableShape @default(ROUND) 
  guests    Guest[]
  
  // Map Position
  x         Int        @default(0)
  y         Int        @default(0)
  rotation  Int        @default(0)
  isLocked  Boolean    @default(false)

  @@unique([eventId, name]) // Names must be unique per event
}

model WishlistItem {
  id          String   @id @default(cuid())
  eventId     String
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  title       String
  description String?
  imageUrl    String?
  link        String?
  isPurchased Boolean  @default(false)
  purchasedBy String?  // Name of guest who bought it
  
  createdAt   DateTime @default(now())
}

model SongRequest {
  id          String   @id @default(cuid())
  eventId     String
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  title       String
  artist      String
  requestedBy String
  
  createdAt   DateTime @default(now())
}

model BudgetItem {
  id            String   @id @default(cuid())
  eventId       String
  event         Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  description   String
  category      String   // e.g., "Venue", "Food", "Dress"
  estimatedCost Float    @default(0)
  actualCost    Float?
  isPaid        Boolean  @default(false)

  createdAt     DateTime @default(now())
}

model GalleryItem {
  id          String        @id @default(cuid())
  eventId     String
  event       Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)

  source      GallerySource // UPLOAD or INSTAGRAM
  url         String        // Cloudinary URL or Instagram Media URL
  thumbnailUrl String?
  caption     String?
  externalId  String?       // Instagram ID
  
  uploadedBy  String?       // Name of uploader if local
  isApproved  Boolean       @default(true) // For moderation

  createdAt   DateTime      @default(now())
}
